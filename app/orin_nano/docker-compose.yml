version: '3.8'

services:
  # ========================================
  # CAMERA SERVICE (Port 5002)
  # GPU-accelerated YOLOv8 + InsightFace
  # Real-time detection, recognition, streaming
  # ========================================
  camera-service:
    build:
      context: ./services/camera-service
      dockerfile: Dockerfile
    network_mode: host
    # Note: ports not needed with host networking - container uses host's network directly
    extra_hosts:
      - "biometric-security:172.20.0.3"
      - "solana-middleware:172.20.0.2"
    volumes:
      - ./data/images:/app/photos
      - /mnt/nvme/mmoment-videos:/app/videos  # Using NVMe SSD for video storage  
      - ./data/face_embeddings:/app/face_embeddings
      - ./data/faces:/app/faces
      - ./data/recordings:/app/recordings
      - ./data/config:/app/config
      - ./data/device:/opt/mmoment/device  # Persistent device keypair storage
      # Development: Mount code for live changes (comment out for production)
      - ./services/camera-service:/app
      - ./apps:/opt/mmoment/apps  # CV apps directory
      - /tmp/.X11-unix:/tmp/.X11-unix:rw
      - /dev:/dev
    devices:
      - /dev/video0:/dev/video0
      - /dev/video1:/dev/video1
    environment:
      - DISPLAY=${DISPLAY}
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=compute,utility,display
      - BIOMETRIC_SECURITY_URL=http://biometric-security:5003
      - SOLANA_MIDDLEWARE_URL=http://solana-middleware:5001
      # Backend connection for WebRTC signaling and device registration
      - BACKEND_HOST=mmoment-production.up.railway.app
      - BACKEND_PORT=443
      - BACKEND_URL=https://mmoment-production.up.railway.app
      # WebRTC will auto-detect external IP or use TURN relay
      - WEBRTC_EXTERNAL_IP=192.168.1.232
      # aiortc port range for minimal WebRTC
      - AIORTC_RTP_MIN_PORT=10000
      - AIORTC_RTP_MAX_PORT=10100
      # Force Python to use the external IP for socket binding
      - HOSTNAME=192.168.1.232
      - HOST=192.168.1.232
      # Blockchain Configuration
      - CAMERA_PROGRAM_ID=E67WTa1NpFVoapXwYYQmXzru3pyhaN9Kj3wPdZEyyZsL
      # CAMERA_PDA will be set dynamically after device registration
      - SOLANA_RPC_URL=https://api.devnet.solana.com
      # Cloudflare Configuration for DNS automation
      - CLOUDFLARE_API_TOKEN=${CLOUDFLARE_API_TOKEN}
      - CLOUDFLARE_ZONE_ID=${CLOUDFLARE_ZONE_ID}
      - CLOUDFLARE_TUNNEL_ID=${CLOUDFLARE_TUNNEL_ID}
      # Livepeer Configuration REMOVED - using WebRTC/WHIP for all streaming
      # - LIVEPEER_API_KEY=${LIVEPEER_API_KEY}
      # - LIVEPEER_STREAM_KEY=${LIVEPEER_STREAM_KEY}
      # - LIVEPEER_INGEST_URL=rtmp://rtmp.livepeer.com/live
      # - LIVEPEER_PLAYBACK_ID=${LIVEPEER_PLAYBACK_ID}
    runtime: nvidia
    privileged: true
    cap_add:
      - NET_ADMIN
      - NET_RAW
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5002/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    depends_on:
      - biometric-security
      - solana-middleware

  # ========================================
  # BIOMETRIC SECURITY SERVICE (Port 5003)
  # Encryption, NFT packaging, secure purging
  # CPU-only container - PRIVATE NETWORK ONLY
  # ========================================
  biometric-security:
    build:
      context: ./services/biometric-security
      dockerfile: Dockerfile
    networks:
      mmoment-network:
        ipv4_address: 172.20.0.3
    environment:
      - SOLANA_MIDDLEWARE_URL=http://solana-middleware:5001
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5003/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ========================================
  # SOLANA MIDDLEWARE (Port 5001)
  # Blockchain operations, NFT minting - PRIVATE NETWORK ONLY
  # ========================================
  solana-middleware:
    build:
      context: ./services/solana-middleware
      dockerfile: Dockerfile
    volumes:
      - ./data/config:/app/config  # Share device config with camera service
      - ./data/device:/opt/mmoment/device  # Device keypair for Phase 3 timeline signing
      - /etc/machine-id:/etc/machine-id:ro  # Hardware ID for keypair decryption
    networks:
      mmoment-network:
        ipv4_address: 172.20.0.2
    environment:
      - SOLANA_NETWORK=devnet
      - SOLANA_RPC_URL=https://api.devnet.solana.com
      - CAMERA_NETWORK_PROGRAM_ID=E67WTa1NpFVoapXwYYQmXzru3pyhaN9Kj3wPdZEyyZsL
      - CAMERA_PROGRAM_ID=E67WTa1NpFVoapXwYYQmXzru3pyhaN9Kj3wPdZEyyZsL
      # CAMERA_PDA will be set dynamically after device registration
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5001/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3

networks:
  mmoment-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16 