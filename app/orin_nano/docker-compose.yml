version: '3.8'

services:
  # ========================================
  # CAMERA SERVICE (Port 5002)
  # GPU-accelerated YOLOv8 + InsightFace
  # Real-time detection, recognition, streaming
  # ========================================
  camera-service:
    build:
      context: ./services/camera-service
      dockerfile: Dockerfile
    network_mode: host
    # Note: ports not needed with host networking - container uses host's network directly
    extra_hosts:
      - "biometric-security:172.20.0.3"
      - "solana-middleware:172.20.0.2"
    volumes:
      - /mnt/nvme/mmoment-photos:/app/photos  # NVMe SSD for photo storage
      - /mnt/nvme/mmoment-videos:/app/videos  # NVMe SSD for video storage
      - ./data/face_embeddings:/app/face_embeddings
      - ./data/faces:/app/faces
      - ./data/recordings:/app/recordings
      - ./data/config:/app/config
      - ./data/device:/opt/mmoment/device  # Persistent device keypair storage
      # Development mount - Python code changes work without rebuild
      - ./services/camera-service:/app
      - ./apps:/opt/mmoment/apps  # CV apps directory
      - ./cv_dev:/app/cv_dev  # CV dev environment
      - /tmp/.X11-unix:/tmp/.X11-unix:rw
      - /tmp/argus_socket:/tmp/argus_socket  # nvargus-daemon socket for CSI camera
      - ~/.Xauthority:/root/.Xauthority:ro
      # Host TensorRT libraries (nvidia runtime doesn't include these)
      - /lib/aarch64-linux-gnu/libnvinfer.so.10.7.0:/lib/aarch64-linux-gnu/libnvinfer.so.10.7.0:ro
      - /lib/aarch64-linux-gnu/libnvinfer_plugin.so.10.7.0:/lib/aarch64-linux-gnu/libnvinfer_plugin.so.10.7.0:ro
      - /lib/aarch64-linux-gnu/libnvonnxparser.so.10.7.0:/lib/aarch64-linux-gnu/libnvonnxparser.so.10.7.0:ro
      # Tegra EGL libraries for headless GPU buffer operations (NvBufSurface)
      - /usr/lib/aarch64-linux-gnu/tegra-egl:/usr/lib/aarch64-linux-gnu/tegra-egl:ro
      - /usr/share/glvnd/egl_vendor.d:/usr/share/glvnd/egl_vendor.d:ro
      # Mount host's native directory with binary and TensorRT engines
      - ./native/build:/app/native/build:ro
      - ./native/yolov8n-pose-native.engine:/app/native/yolov8n-pose-native.engine:ro
      - ./native/retinaface.engine:/app/native/retinaface.engine:ro
      - ./native/scrfd_10g.engine:/app/native/scrfd_10g.engine:ro
      - ./native/arcface_r50.engine:/app/native/arcface_r50.engine:ro
      - ./native/adaface_ir50.engine:/app/native/adaface_ir50.engine:ro
      - ./native/osnet_x0_25.engine:/app/native/osnet_x0_25.engine:ro
    # Camera devices - native server now runs inside container
    # DRI devices required for headless EGL on Jetson
    devices:
      # Logitech StreamCam on video0/video1
      - /dev/video0:/dev/video0
      - /dev/video1:/dev/video1
      - /dev/dri:/dev/dri
    environment:
      - DISPLAY=${DISPLAY}
      - XAUTHORITY=/root/.Xauthority
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=compute,utility,display,video
      # Force nvidia EGL vendor for headless operation
      - __EGL_VENDOR_LIBRARY_FILENAMES=/usr/lib/aarch64-linux-gnu/tegra-egl/nvidia.json
      # Library paths for native binary (tegra-egl first for NvBufSurface EGL)
      - LD_LIBRARY_PATH=/usr/lib/aarch64-linux-gnu/tegra-egl:/lib/aarch64-linux-gnu:/usr/lib/aarch64-linux-gnu/nvidia:/app/native:/app/native/build
      - BIOMETRIC_SECURITY_URL=http://biometric-security:5003
      - SOLANA_MIDDLEWARE_URL=http://solana-middleware:5001
      # Backend connection for WebRTC signaling and device registration
      - BACKEND_HOST=mmoment-production.up.railway.app
      - BACKEND_PORT=443
      - BACKEND_URL=https://mmoment-production.up.railway.app
      # WebRTC will auto-detect external IP or use TURN relay
      - WEBRTC_EXTERNAL_IP=192.168.1.232
      # aiortc port range for minimal WebRTC
      - AIORTC_RTP_MIN_PORT=10000
      - AIORTC_RTP_MAX_PORT=10100
      # Force Python to use the external IP for socket binding
      - HOSTNAME=192.168.1.232
      - HOST=192.168.1.232
      # Blockchain Configuration
      - CAMERA_PROGRAM_ID=E67WTa1NpFVoapXwYYQmXzru3pyhaN9Kj3wPdZEyyZsL
      # CAMERA_PDA will be set dynamically after device registration
      - SOLANA_RPC_URL=https://api.devnet.solana.com
      # Competition Escrow Program ID
      - COMPETITION_PROGRAM_ID=32jXEKF2GDjbezk4x8SkgddeVNMYkFjEh5PiAJijxqLJ
      # Camera owner wallet - receives failed prize funds in ThresholdSplit mode
      - CAMERA_OWNER_WALLET=${CAMERA_OWNER_WALLET}
      # Cloudflare Configuration for DNS automation
      - CLOUDFLARE_API_TOKEN=${CLOUDFLARE_API_TOKEN}
      - CLOUDFLARE_ZONE_ID=${CLOUDFLARE_ZONE_ID}
      - CLOUDFLARE_TUNNEL_ID=${CLOUDFLARE_TUNNEL_ID}
      # Walrus Storage Configuration (decentralized blob storage)
      - STORAGE_PROVIDER=walrus
      - WALRUS_PUBLISHER_URL=https://walrus-mainnet-publisher-1.staketab.org
      - WALRUS_AGGREGATOR_URL=https://aggregator.walrus-mainnet.walrus.space
      # Testing: Skip video uploads to Walrus (set to "true" to disable)
      - SKIP_VIDEO_UPLOAD=true
      # CV Dev Mode: Use video file instead of camera (no camera required)
      - CV_DEV_MODE=false
      # Native Mode: C++ TensorRT inference server runs inside this container
      - NATIVE_MODE=true
      # CV_DEV_VIDEO is optional - use /api/dev/load to select videos dynamically
      # Livepeer Configuration REMOVED - using WebRTC/WHIP for all streaming
      # - LIVEPEER_API_KEY=${LIVEPEER_API_KEY}
      # - LIVEPEER_STREAM_KEY=${LIVEPEER_STREAM_KEY}
      # - LIVEPEER_INGEST_URL=rtmp://rtmp.livepeer.com/live
      # - LIVEPEER_PLAYBACK_ID=${LIVEPEER_PLAYBACK_ID}
    runtime: nvidia
    privileged: true
    cap_add:
      - NET_ADMIN
      - NET_RAW
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5002/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    depends_on:
      - biometric-security
      - solana-middleware

  # ========================================
  # BIOMETRIC SECURITY SERVICE (Port 5003)
  # Encryption, NFT packaging, secure purging
  # CPU-only container - PRIVATE NETWORK ONLY
  # ========================================
  biometric-security:
    build:
      context: ./services/biometric-security
      dockerfile: Dockerfile
    networks:
      mmoment-network:
        ipv4_address: 172.20.0.3
    environment:
      - SOLANA_MIDDLEWARE_URL=http://solana-middleware:5001
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5003/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ========================================
  # SOLANA MIDDLEWARE (Port 5001)
  # Blockchain operations, NFT minting - PRIVATE NETWORK ONLY
  # ========================================
  solana-middleware:
    build:
      context: ./services/solana-middleware
      dockerfile: Dockerfile
    volumes:
      - ./data/config:/app/config  # Share device config with camera service
      - ./data/device:/opt/mmoment/device  # Device keypair for Phase 3 timeline signing
      - /etc/machine-id:/etc/machine-id:ro  # Hardware ID for keypair decryption
    networks:
      mmoment-network:
        ipv4_address: 172.20.0.2
    environment:
      - SOLANA_NETWORK=devnet
      - SOLANA_RPC_URL=https://api.devnet.solana.com
      - CAMERA_NETWORK_PROGRAM_ID=E67WTa1NpFVoapXwYYQmXzru3pyhaN9Kj3wPdZEyyZsL
      - CAMERA_PROGRAM_ID=E67WTa1NpFVoapXwYYQmXzru3pyhaN9Kj3wPdZEyyZsL
      # CAMERA_PDA will be set dynamically after device registration
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5001/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3

networks:
  mmoment-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16 