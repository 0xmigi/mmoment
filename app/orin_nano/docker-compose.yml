version: '3.8'

services:
  # ========================================
  # CAMERA SERVICE (Port 5002)
  # GPU-accelerated YOLOv8 + InsightFace
  # Real-time detection, recognition, streaming
  # ========================================
  camera-service:
    build:
      context: ./services/camera-service
      dockerfile: Dockerfile
    ports:
      - "5002:5002"
    volumes:
      - ./data/images:/app/photos
      - ./data/videos:/app/videos  
      - ./data/face_embeddings:/app/face_embeddings
      - ./data/faces:/app/faces
      - ./data/recordings:/app/recordings
      - ./data/config:/app/config
      - ./data/device:/opt/mmoment  # Persistent device keypair storage
      # Development: Mount code for live changes (comment out for production)
      - ./services/camera-service:/app
      - /tmp/.X11-unix:/tmp/.X11-unix:rw
      - /dev:/dev
    environment:
      - DISPLAY=${DISPLAY}
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=compute,utility,display
      - BIOMETRIC_SECURITY_URL=http://biometric-security:5003
      - SOLANA_MIDDLEWARE_URL=http://solana-middleware:5001
      # Blockchain Configuration  
      - CAMERA_PROGRAM_ID=E67WTa1NpFVoapXwYYQmXzru3pyhaN9Kj3wPdZEyyZsL
      # CAMERA_PDA will be set dynamically after device registration
      - SOLANA_RPC_URL=https://api.devnet.solana.com
      # Cloudflare Configuration for DNS automation
      - CLOUDFLARE_API_TOKEN=KZkPikyV6obPoDlxTFwtKxfrxukonzAEpzVs4JM3
      - CLOUDFLARE_ZONE_ID=a14bb2a85b1c73cab3b192854218f2fb
      - CLOUDFLARE_TUNNEL_ID=6257e873-7943-4b85-b8a3-72b5b9d0a500
      # Livepeer Configuration (Current Active Account)
      - LIVEPEER_API_KEY=${LIVEPEER_API_KEY}
      - LIVEPEER_STREAM_KEY=${LIVEPEER_STREAM_KEY}
      - LIVEPEER_INGEST_URL=rtmp://rtmp.livepeer.com/live
      - LIVEPEER_PLAYBACK_ID=${LIVEPEER_PLAYBACK_ID}
      # Previous Account (Commented Out)
      # - LIVEPEER_API_KEY=${LIVEPEER_API_KEY_OLD}
      # - LIVEPEER_STREAM_KEY=${LIVEPEER_STREAM_KEY_OLD}
      # - LIVEPEER_INGEST_URL=rtmp://rtmp.livepeer.com/live
      # - LIVEPEER_PLAYBACK_ID=${LIVEPEER_PLAYBACK_ID_OLD}
    networks:
      - mmoment-network
    runtime: nvidia
    privileged: true
    cap_add:
      - NET_ADMIN
      - NET_RAW
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5002/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    depends_on:
      - biometric-security
      - solana-middleware

  # ========================================
  # BIOMETRIC SECURITY SERVICE (Port 5003)
  # Encryption, NFT packaging, secure purging
  # CPU-only container - PRIVATE NETWORK ONLY
  # ========================================
  biometric-security:
    build:
      context: ./services/biometric-security
      dockerfile: Dockerfile
    networks:
      - mmoment-network
    environment:
      - SOLANA_MIDDLEWARE_URL=http://solana-middleware:5001
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5003/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ========================================
  # SOLANA MIDDLEWARE (Port 5001)
  # Blockchain operations, NFT minting - PRIVATE NETWORK ONLY
  # ========================================
  solana-middleware:
    build:
      context: ./services/solana-middleware
      dockerfile: Dockerfile
    volumes:
      - ./data/config:/app/config  # Share device config with camera service
    networks:
      - mmoment-network
    environment:
      - SOLANA_NETWORK=devnet
      - SOLANA_RPC_URL=https://api.devnet.solana.com
      - CAMERA_NETWORK_PROGRAM_ID=E67WTa1NpFVoapXwYYQmXzru3pyhaN9Kj3wPdZEyyZsL
      - CAMERA_PROGRAM_ID=E67WTa1NpFVoapXwYYQmXzru3pyhaN9Kj3wPdZEyyZsL
      # CAMERA_PDA will be set dynamically after device registration
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5001/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3

networks:
  mmoment-network:
    driver: bridge 