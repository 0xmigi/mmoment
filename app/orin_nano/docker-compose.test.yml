version: '3.8'

services:
  camera-service:
    build:
      context: ./services/camera-service
      dockerfile: Dockerfile
    environment:
      - DISPLAY=${DISPLAY:-}
      - CUDA_VISIBLE_DEVICES=0
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=compute,utility
      - PYTHONUNBUFFERED=1
      - CAMERA_DEVICE=/dev/video1
      # Livepeer streaming configuration
      - LIVEPEER_API_KEY=${LIVEPEER_API_KEY}
      - LIVEPEER_STREAM_KEY=${LIVEPEER_STREAM_KEY}
      - LIVEPEER_INGEST_URL=rtmp://rtmp.livepeer.com/live
      - LIVEPEER_PLAYBACK_ID=${LIVEPEER_PLAYBACK_ID}
      # - LIVEPEER_API_KEY=${LIVEPEER_API_KEY_OLD}
      # - LIVEPEER_STREAM_KEY=${LIVEPEER_STREAM_KEY_OLD}
      # - LIVEPEER_INGEST_URL=rtmp://rtmp.livepeer.com/live
      # - LIVEPEER_PLAYBACK_ID=${LIVEPEER_PLAYBACK_ID_OLD}
    privileged: true
    runtime: nvidia
    devices:
      - /dev/video0:/dev/video0
      - /dev/video1:/dev/video1
      - /dev/video2:/dev/video2
    volumes:
      - /dev:/dev
      - /tmp/.X11-unix:/tmp/.X11-unix
      # GPU model cache
      - /mnt/nvme/jetson_cache/insightface:/root/.insightface
      - /mnt/nvme/jetson_cache/ultralytics:/root/.config/Ultralytics
      # Temporary local storage
      - ./temp_photos:/workspace/photos
      - ./temp_videos:/workspace/videos
      - ./temp_logs:/workspace/logs
    restart: unless-stopped
    network_mode: host
