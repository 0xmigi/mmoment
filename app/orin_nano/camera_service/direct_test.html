<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Direct Camera Service Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f0f0f0;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .control-section {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }
        .control-section h3 {
            margin-top: 0;
            color: #495057;
            border-bottom: 2px solid #007bff;
            padding-bottom: 5px;
        }
        .video-container {
            text-align: center;
            margin: 20px 0;
        }
        #videoStream {
            max-width: 100%;
            border: 2px solid #333;
            border-radius: 10px;
        }
        .controls {
            display: flex;
            gap: 10px;
            margin: 15px 0;
            flex-wrap: wrap;
        }
        button {
            padding: 8px 16px;
            font-size: 14px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
            min-width: 120px;
        }
        .connect-btn {
            background-color: #28a745;
            color: white;
        }
        .connect-btn:hover {
            background-color: #218838;
        }
        .disconnect-btn {
            background-color: #dc3545;
            color: white;
        }
        .disconnect-btn:hover {
            background-color: #c82333;
        }
        .enroll-btn {
            background-color: #007bff;
            color: white;
        }
        .enroll-btn:hover {
            background-color: #0056b3;
        }
        .gesture-btn {
            background-color: #fd7e14;
            color: white;
        }
        .gesture-btn:hover {
            background-color: #e8650e;
        }
        .capture-btn {
            background-color: #6f42c1;
            color: white;
        }
        .capture-btn:hover {
            background-color: #5a32a3;
        }
        .toggle-btn {
            background-color: #6c757d;
            color: white;
        }
        .toggle-btn:hover {
            background-color: #545b62;
        }
        .toggle-btn.active {
            background-color: #28a745;
        }
        .danger-btn {
            background-color: #dc3545;
            color: white;
        }
        .danger-btn:hover {
            background-color: #c82333;
        }
        .status {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
            font-weight: bold;
        }
        .status.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .input-group {
            margin: 10px 0;
        }
        input[type="text"] {
            padding: 8px;
            font-size: 16px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 200px;
        }
        .session-info {
            background-color: #e9ecef;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .results-area {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            min-height: 100px;
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        .media-preview {
            max-width: 200px;
            max-height: 150px;
            border-radius: 5px;
            margin: 10px 0;
        }
        
        .media-gallery {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .media-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            background: white;
            border-radius: 8px;
            padding: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            max-width: 300px;
        }
        
        .media-item img, .media-item video {
            max-width: 280px;
            max-height: 200px;
            border-radius: 4px;
            object-fit: cover;
        }
        
        .video-fallback {
            background: #f0f0f0;
            border: 2px dashed #ccc;
            padding: 20px;
            text-align: center;
            border-radius: 4px;
            color: #666;
        }
        
        .video-fallback a {
            color: #007bff;
            text-decoration: none;
        }
        
        .video-fallback a:hover {
            text-decoration: underline;
        }
        
        .media-item .media-info {
            margin-top: 8px;
            text-align: center;
            font-size: 12px;
            color: #666;
        }
        
        .media-item .media-filename {
            font-weight: bold;
            color: #333;
            margin-bottom: 4px;
        }
        
        .media-item .media-timestamp {
            color: #888;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Direct Camera Service Test - Complete Interface</h1>
        <p>This page connects directly to the camera service on port 5002, bypassing the frontend bridge.</p>
        
        <div class="input-group">
            <label for="walletAddress">Wallet Address/Name:</label>
            <input type="text" id="walletAddress" value="Jeoseph" placeholder="Enter wallet address">
        </div>
        
        <div class="controls-grid">
            <!-- Connection Controls -->
            <div class="control-section">
                <h3>üîó Connection</h3>
                <div class="controls">
                    <button class="connect-btn" onclick="connectWallet()">Connect</button>
                    <button class="disconnect-btn" onclick="disconnectWallet()" disabled id="disconnectBtn">Disconnect</button>
                </div>
                <div id="connectionStatus" class="status info">Ready to connect</div>
                <div id="sessionInfo" class="session-info" style="display: none;"></div>
            </div>

            <!-- Face Recognition Controls -->
            <div class="control-section">
                <h3>üë§ Face Recognition</h3>
                <div class="controls">
                    <button class="enroll-btn" onclick="enrollFace()" disabled id="enrollBtn">Enroll Face</button>
                    <button class="enroll-btn" onclick="recognizeFace()" id="recognizeBtn">Recognize Faces</button>
                </div>
                <div class="controls">
                    <button class="toggle-btn" onclick="listFaces()">List Enrolled Faces</button>
                    <button class="danger-btn" onclick="clearAllFaces()">Clear All Faces</button>
                </div>
                <div id="faceStatus" class="status info">Face recognition ready</div>
                <div id="faceResults" class="results-area"></div>
            </div>

            <!-- Gesture Recognition Controls -->
            <div class="control-section">
                <h3>‚úã Gesture Recognition & Auto Actions</h3>
                <div class="controls">
                    <button class="gesture-btn" onclick="startGestureRecognition()" disabled id="gestureBtn">Start Auto Gestures</button>
                    <button class="gesture-btn" onclick="stopGestureRecognition()" disabled id="stopGestureBtn">Stop Auto Gestures</button>
                </div>
                <div class="controls">
                    <button class="toggle-btn" onclick="getCurrentGesture()">Check Current Gesture</button>
                </div>
                <div style="background: #e7f3ff; padding: 8px; border-radius: 4px; margin: 10px 0; font-size: 12px;">
                    <strong>Auto Actions:</strong><br>
                    ‚úåÔ∏è Peace Sign ‚Üí üì∏ Capture Photo<br>
                    üëç Thumbs Up ‚Üí üé• Start Recording<br>
                    üñêÔ∏è Open Palm ‚Üí ‚èπÔ∏è Stop Recording
                </div>
                <div id="gestureStatus" class="status info">Gesture recognition ready</div>
                <div id="gestureResults" class="results-area"></div>
            </div>

            <!-- Capture Controls -->
            <div class="control-section">
                <h3>üì∏ Capture Media</h3>
                <div class="controls">
                    <button class="capture-btn" onclick="capturePhoto()" disabled id="capturePhotoBtn">Capture Photo</button>
                    <button class="capture-btn" onclick="startRecording()" disabled id="startRecordBtn">Start Recording</button>
                    <button class="capture-btn" onclick="stopRecording()" disabled id="stopRecordBtn">Stop Recording</button>
                </div>
                <div class="controls">
                    <button class="toggle-btn" onclick="listPhotos()">List Photos</button>
                    <button class="toggle-btn" onclick="listVideos()">List Videos</button>
                    <button class="toggle-btn" onclick="listAllMedia()">List All Media</button>
                </div>
                <div id="captureStatus" class="status info">Capture ready</div>
                <div id="captureResults" class="results-area"></div>
                <img id="capturedImage" class="media-preview" style="display: none;">
            </div>

            <!-- Visualization Controls -->
            <div class="control-section">
                <h3>üëÅÔ∏è Visualization</h3>
                <div class="controls">
                    <button class="toggle-btn" onclick="toggleFaceBoxes(true)" id="enableFaceBoxes">Enable Face Boxes</button>
                    <button class="toggle-btn" onclick="toggleFaceBoxes(false)" id="disableFaceBoxes">Disable Face Boxes</button>
                </div>
                <div class="controls">
                    <button class="toggle-btn" onclick="toggleGestureVisualization(true)" id="enableGestureViz">Enable Gesture Labels</button>
                    <button class="toggle-btn" onclick="toggleGestureVisualization(false)" id="disableGestureViz">Disable Gesture Labels</button>
                </div>
                <div id="visualizationStatus" class="status info">Visualization controls</div>
            </div>

            <!-- System Controls -->
            <div class="control-section">
                <h3>‚öôÔ∏è System</h3>
                <div class="controls">
                    <button class="toggle-btn" onclick="healthCheck()">Health Check</button>
                    <button class="toggle-btn" onclick="refreshStream()">Refresh Stream</button>
                    <button class="toggle-btn" onclick="testVideoUrls()">Test Video URLs</button>
                    <button class="toggle-btn" onclick="testVideoPlayback()">Test Video Playback</button>
                </div>
                <div id="systemStatus" class="status info">System ready</div>
                <div id="systemResults" class="results-area"></div>
            </div>
        </div>
        
        <div class="video-container">
            <img id="videoStream" src="" alt="Camera stream will appear here" style="display: none;">
        </div>
        
        <!-- Media Gallery positioned below the video stream -->
        <div class="container" style="margin-top: 20px;">
            <h2>üì∏ Media Gallery - Real-time Captures</h2>
            <p>Photos and videos captured through gestures or manual controls appear here automatically.</p>
            
            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 15px 0; border-left: 4px solid #007bff;">
                <strong>üéØ Testing Tips:</strong><br>
                ‚Ä¢ Make clear, deliberate gestures for best detection<br>
                ‚Ä¢ Wait for 3-second cooldown between gesture actions<br>
                ‚Ä¢ Watch the gesture results area for real-time feedback<br>
                ‚Ä¢ New captures appear here automatically (newest first)
            </div>
            
            <div id="mediaGallery" class="media-gallery" style="min-height: 200px;">
                <div style="text-align: center; color: #666; padding: 40px;">
                    <p>üé¨ No media captured yet</p>
                    <p>Start making gestures or use manual controls to see your captures here!</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentSession = null;
        let gesturePolling = null;
        const CAMERA_SERVICE_URL = 'http://localhost:5002';
        
        function createVideoElement(filename) {
            const videoUrl = `${CAMERA_SERVICE_URL}/videos/${filename}`;
            
            // Try a much simpler approach - just basic video element
            const videoHtml = `
                <video controls preload="metadata" 
                       style="width: 100%; max-width: 280px; max-height: 200px; background: #f0f0f0;"
                       src="${videoUrl}"
                       onloadstart="console.log('Video loading:', '${filename}');"
                       oncanplay="console.log('Video ready:', '${filename}'); this.style.background='#000';"
                       oncanplaythrough="console.log('Video fully loaded:', '${filename}');"
                       onerror="console.error('Video error:', '${filename}'); handleVideoError(this, '${filename}');"
                       onloadedmetadata="console.log('Video metadata loaded:', '${filename}');">
                    <p>Your browser doesn't support video playback. <a href="${videoUrl}" target="_blank">Open in new tab</a></p>
                </video>
            `;
            
            return videoHtml;
        }
        
        function handleVideoError(videoElement, filename) {
            console.error('Video load error for:', filename);
            const fallbackHtml = `
                <div class="video-fallback">
                    <p>‚ö†Ô∏è Video cannot be played</p>
                    <a href="${CAMERA_SERVICE_URL}/videos/${filename}" target="_blank">üé• Open in new tab</a><br>
                    <a href="${CAMERA_SERVICE_URL}/videos/${filename}" download="${filename}">üì• Download video</a>
                </div>
            `;
            videoElement.outerHTML = fallbackHtml;
        }
        
        function showStatus(elementId, message, type = 'info') {
            const statusDiv = document.getElementById(elementId);
            statusDiv.className = `status ${type}`;
            statusDiv.textContent = message;
            statusDiv.style.display = 'block';
        }
        
        function updateResults(elementId, content) {
            const resultsDiv = document.getElementById(elementId);
            resultsDiv.innerHTML = content;
        }
        
        function updateSessionInfo() {
            const sessionDiv = document.getElementById('sessionInfo');
            if (currentSession) {
                sessionDiv.innerHTML = `
                    <strong>Session Active:</strong><br>
                    Session ID: ${currentSession.session_id}<br>
                    Wallet: ${currentSession.wallet_address}<br>
                    Camera PDA: ${currentSession.camera_pda || 'N/A'}
                `;
                sessionDiv.style.display = 'block';
                
                // Enable session-dependent buttons
                document.getElementById('disconnectBtn').disabled = false;
                document.getElementById('enrollBtn').disabled = false;
                document.getElementById('gestureBtn').disabled = false;
                document.getElementById('capturePhotoBtn').disabled = false;
                document.getElementById('startRecordBtn').disabled = false;
            } else {
                sessionDiv.style.display = 'none';
                
                // Disable session-dependent buttons
                document.getElementById('disconnectBtn').disabled = true;
                document.getElementById('enrollBtn').disabled = true;
                document.getElementById('gestureBtn').disabled = true;
                document.getElementById('capturePhotoBtn').disabled = true;
                document.getElementById('startRecordBtn').disabled = true;
                document.getElementById('stopRecordBtn').disabled = true;
                document.getElementById('stopGestureBtn').disabled = true;
            }
        }
        
        async function connectWallet() {
            const walletAddress = document.getElementById('walletAddress').value.trim();
            if (!walletAddress) {
                showStatus('connectionStatus', 'Please enter a wallet address', 'error');
                return;
            }
            
            try {
                showStatus('connectionStatus', 'Connecting...', 'info');
                
                const response = await fetch(`${CAMERA_SERVICE_URL}/connect`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ wallet_address: walletAddress })
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    currentSession = data;
                    showStatus('connectionStatus', `Connected successfully! Session ID: ${data.session_id}`, 'success');
                    updateSessionInfo();
                    startVideoStream();
                    
                    // Auto-load existing media when connecting
                    setTimeout(() => listAllMedia(), 1000);
                } else {
                    showStatus('connectionStatus', `Connection failed: ${data.message || 'Unknown error'}`, 'error');
                }
            } catch (error) {
                showStatus('connectionStatus', `Connection error: ${error.message}`, 'error');
            }
        }
        
        async function disconnectWallet() {
            if (!currentSession) return;
            
            try {
                const response = await fetch(`${CAMERA_SERVICE_URL}/disconnect`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        wallet_address: currentSession.wallet_address,
                        session_id: currentSession.session_id
                    })
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    currentSession = null;
                    showStatus('connectionStatus', 'Disconnected successfully', 'info');
                    updateSessionInfo();
                    stopGesturePolling();
                } else {
                    showStatus('connectionStatus', `Disconnect failed: ${data.message || 'Unknown error'}`, 'error');
                }
            } catch (error) {
                showStatus('connectionStatus', `Disconnect error: ${error.message}`, 'error');
            }
        }
        
        async function enrollFace() {
            if (!currentSession) return;
            
            try {
                showStatus('faceStatus', 'Enrolling face...', 'info');
                
                const response = await fetch(`${CAMERA_SERVICE_URL}/enroll_face`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        wallet_address: currentSession.wallet_address,
                        session_id: currentSession.session_id
                    })
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    showStatus('faceStatus', `Face enrolled successfully! ${data.message}`, 'success');
                    updateResults('faceResults', `‚úÖ Face enrolled for ${currentSession.wallet_address}`);
                } else {
                    showStatus('faceStatus', `Face enrollment failed: ${data.error || 'Unknown error'}`, 'error');
                    updateResults('faceResults', `‚ùå Enrollment failed: ${data.error}`);
                }
            } catch (error) {
                showStatus('faceStatus', `Enrollment error: ${error.message}`, 'error');
            }
        }
        
        async function recognizeFace() {
            try {
                showStatus('faceStatus', 'Recognizing faces...', 'info');
                
                const response = await fetch(`${CAMERA_SERVICE_URL}/recognize_face`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({})
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    showStatus('faceStatus', `Recognition complete: ${data.detected_faces} detected, ${data.recognized_faces} recognized`, 'success');
                    
                    let results = `Detected: ${data.detected_faces} faces\nRecognized: ${data.recognized_faces} faces\n\n`;
                    if (data.recognized_data) {
                        Object.entries(data.recognized_data).forEach(([wallet, info]) => {
                            results += `üë§ ${wallet}: ${(info.confidence * 100).toFixed(1)}% confidence\n`;
                        });
                    }
                    updateResults('faceResults', results);
                } else {
                    showStatus('faceStatus', `Recognition failed: ${data.error || 'Unknown error'}`, 'error');
                }
            } catch (error) {
                showStatus('faceStatus', `Recognition error: ${error.message}`, 'error');
            }
        }
        
        async function listFaces() {
            try {
                const response = await fetch(`${CAMERA_SERVICE_URL}/get_enrolled_faces`);
                const data = await response.json();
                
                if (response.ok && data.success) {
                    showStatus('faceStatus', `Found ${data.count} enrolled faces`, 'success');
                    updateResults('faceResults', `Enrolled faces (${data.count}):\n${data.faces.join('\n')}`);
                } else {
                    showStatus('faceStatus', `Failed to list faces: ${data.error || 'Unknown error'}`, 'error');
                }
            } catch (error) {
                showStatus('faceStatus', `List faces error: ${error.message}`, 'error');
            }
        }
        
        async function clearAllFaces() {
            if (!confirm('Are you sure you want to clear ALL enrolled faces? This cannot be undone.')) return;
            
            try {
                const response = await fetch(`${CAMERA_SERVICE_URL}/clear_enrolled_faces`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({})
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    showStatus('faceStatus', 'All faces cleared successfully', 'success');
                    updateResults('faceResults', 'üóëÔ∏è All enrolled faces have been cleared');
                } else {
                    showStatus('faceStatus', `Failed to clear faces: ${data.error || 'Unknown error'}`, 'error');
                }
            } catch (error) {
                showStatus('faceStatus', `Clear faces error: ${error.message}`, 'error');
            }
        }
        
        async function startGestureRecognition() {
            if (!currentSession) return;
            
            try {
                showStatus('gestureStatus', 'Starting gesture recognition...', 'info');
                
                const response = await fetch(`${CAMERA_SERVICE_URL}/toggle_gesture_visualization`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ enabled: true })
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    showStatus('gestureStatus', 'Gesture recognition started!', 'success');
                    document.getElementById('stopGestureBtn').disabled = false;
                    startGesturePolling();
                } else {
                    showStatus('gestureStatus', `Failed to start gesture recognition: ${data.error || 'Unknown error'}`, 'error');
                }
            } catch (error) {
                showStatus('gestureStatus', `Gesture start error: ${error.message}`, 'error');
            }
        }
        
        async function stopGestureRecognition() {
            try {
                const response = await fetch(`${CAMERA_SERVICE_URL}/toggle_gesture_visualization`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ enabled: false })
                });
                
                showStatus('gestureStatus', 'Gesture recognition stopped', 'info');
                document.getElementById('stopGestureBtn').disabled = true;
                stopGesturePolling();
            } catch (error) {
                showStatus('gestureStatus', `Gesture stop error: ${error.message}`, 'error');
            }
        }
        
        let lastGestureAction = null;
        let gestureActionCooldown = false;
        
        function startGesturePolling() {
            if (gesturePolling) clearInterval(gesturePolling);
            
            gesturePolling = setInterval(async () => {
                try {
                    const response = await fetch(`${CAMERA_SERVICE_URL}/current_gesture`);
                    const data = await response.json();
                    
                    if (response.ok && data.success) {
                        const gesture = data.gesture || 'none';
                        const confidence = data.confidence || 0;
                        
                        if (gesture !== 'none' && confidence > 0.7) { // Higher confidence for actions
                            updateResults('gestureResults', `‚úã Current: ${gesture.toUpperCase()} (${(confidence * 100).toFixed(0)}%)\nTime: ${new Date().toLocaleTimeString()}`);
                            
                            // Trigger automatic actions based on gestures
                            await handleGestureAction(gesture, confidence);
                        } else {
                            updateResults('gestureResults', 'üëã No gesture detected');
                        }
                    }
                } catch (error) {
                    console.error('Gesture polling error:', error);
                }
            }, 500);
        }
        
        async function handleGestureAction(gesture, confidence) {
            // Only act if we have a valid session and aren't in cooldown
            if (!currentSession || gestureActionCooldown) return;
            
            // Prevent rapid-fire actions with the same gesture
            if (lastGestureAction === gesture) return;
            
            const gestureMap = {
                'peace': 'üì∏ Photo',
                'thumbs_up': 'üé• Start Recording', 
                'palm': '‚èπÔ∏è Stop Recording'
            };
            
            if (gestureMap[gesture]) {
                lastGestureAction = gesture;
                gestureActionCooldown = true;
                
                showStatus('gestureStatus', `üéØ Gesture Action: ${gestureMap[gesture]}`, 'success');
                
                try {
                    switch(gesture) {
                        case 'peace':
                            await capturePhoto();
                            updateResults('gestureResults', `‚úåÔ∏è PEACE SIGN DETECTED!\nüì∏ Photo captured automatically\nConfidence: ${(confidence * 100).toFixed(0)}%\nTime: ${new Date().toLocaleTimeString()}`);
                            break;
                            
                        case 'thumbs_up':
                            await startRecording();
                            updateResults('gestureResults', `üëç THUMBS UP DETECTED!\nüé• Recording started automatically\nConfidence: ${(confidence * 100).toFixed(0)}%\nTime: ${new Date().toLocaleTimeString()}`);
                            break;
                            
                        case 'palm':
                            await stopRecording();
                            updateResults('gestureResults', `‚úã PALM GESTURE DETECTED!\n‚èπÔ∏è Recording stopped automatically\nConfidence: ${(confidence * 100).toFixed(0)}%\nTime: ${new Date().toLocaleTimeString()}`);
                            break;
                    }
                } catch (error) {
                    console.error('Gesture action error:', error);
                    showStatus('gestureStatus', `‚ùå Gesture action failed: ${error.message}`, 'error');
                }
                
                // Reset cooldown after 3 seconds
                setTimeout(() => {
                    gestureActionCooldown = false;
                    lastGestureAction = null;
                }, 3000);
            }
        }
        
        function stopGesturePolling() {
            if (gesturePolling) {
                clearInterval(gesturePolling);
                gesturePolling = null;
            }
        }
        
        async function getCurrentGesture() {
            try {
                const response = await fetch(`${CAMERA_SERVICE_URL}/current_gesture`);
                const data = await response.json();
                
                if (response.ok && data.success) {
                    const gesture = data.gesture || 'none';
                    const confidence = data.confidence || 0;
                    showStatus('gestureStatus', `Current gesture: ${gesture} (${(confidence * 100).toFixed(0)}%)`, 'success');
                    updateResults('gestureResults', `Current: ${gesture}\nConfidence: ${(confidence * 100).toFixed(1)}%\nTime: ${new Date().toLocaleTimeString()}`);
                }
            } catch (error) {
                showStatus('gestureStatus', `Gesture check error: ${error.message}`, 'error');
            }
        }
        
        async function capturePhoto() {
            if (!currentSession) return;
            
            try {
                showStatus('captureStatus', 'Capturing photo...', 'info');
                
                const response = await fetch(`${CAMERA_SERVICE_URL}/capture_moment`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        wallet_address: currentSession.wallet_address,
                        session_id: currentSession.session_id
                    })
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    showStatus('captureStatus', 'Photo captured successfully!', 'success');
                    updateResults('captureResults', `üì∏ Photo captured\nPath: ${data.path || 'N/A'}\nTime: ${new Date().toLocaleTimeString()}`);
                    
                    if (data.image_data) {
                        const img = document.getElementById('capturedImage');
                        img.src = data.image_data;
                        img.style.display = 'block';
                    }
                    
                    // Auto-refresh the media gallery to show the new photo
                    setTimeout(() => listAllMedia(), 1000);
                } else {
                    showStatus('captureStatus', `Photo capture failed: ${data.error || 'Unknown error'}`, 'error');
                }
            } catch (error) {
                showStatus('captureStatus', `Capture error: ${error.message}`, 'error');
            }
        }
        
        async function startRecording() {
            if (!currentSession) return;
            
            try {
                showStatus('captureStatus', 'Starting recording...', 'info');
                
                const response = await fetch(`${CAMERA_SERVICE_URL}/start_recording`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        wallet_address: currentSession.wallet_address,
                        session_id: currentSession.session_id,
                        duration: 10
                    })
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    showStatus('captureStatus', 'Recording started (10s max)', 'success');
                    document.getElementById('stopRecordBtn').disabled = false;
                    updateResults('captureResults', 'üé• Recording started...');
                } else {
                    showStatus('captureStatus', `Recording failed: ${data.error || 'Unknown error'}`, 'error');
                }
            } catch (error) {
                showStatus('captureStatus', `Recording error: ${error.message}`, 'error');
            }
        }
        
        async function stopRecording() {
            if (!currentSession) return;
            
            try {
                const response = await fetch(`${CAMERA_SERVICE_URL}/stop_recording`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        wallet_address: currentSession.wallet_address,
                        session_id: currentSession.session_id
                    })
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    showStatus('captureStatus', 'Recording stopped successfully', 'success');
                    document.getElementById('stopRecordBtn').disabled = true;
                    updateResults('captureResults', `üé¨ Recording stopped\nFile: ${data.filename || 'N/A'}`);
                    
                    // Auto-refresh the media gallery to show the new video
                    setTimeout(() => listAllMedia(), 1000);
                } else {
                    showStatus('captureStatus', `Stop recording failed: ${data.error || 'Unknown error'}`, 'error');
                }
            } catch (error) {
                showStatus('captureStatus', `Stop recording error: ${error.message}`, 'error');
            }
        }
        
        async function listPhotos() {
            try {
                const response = await fetch(`${CAMERA_SERVICE_URL}/list_photos`);
                const data = await response.json();
                
                if (response.ok && data.success) {
                    showStatus('captureStatus', `Found ${data.count} photos`, 'success');
                    updateResults('captureResults', `Photos (${data.count}) - displayed below:`);
                    
                    // Display photos in gallery
                    const gallery = document.getElementById('mediaGallery');
                    gallery.innerHTML = '';
                    
                    data.photos.forEach(photo => {
                        const mediaItem = document.createElement('div');
                        mediaItem.className = 'media-item';
                        
                        mediaItem.innerHTML = `
                            <img src="${CAMERA_SERVICE_URL}/photos/${photo.filename}" 
                                 alt="${photo.filename}"
                                 onerror="this.style.display='none'">
                            <div class="media-info">
                                <div class="media-filename">üì∏ ${photo.filename}</div>
                                <div class="media-timestamp">${new Date(photo.timestamp).toLocaleString()}</div>
                                <div class="media-timestamp">${(photo.size / 1024).toFixed(1)} KB</div>
                            </div>
                        `;
                        
                        gallery.appendChild(mediaItem);
                    });
                }
            } catch (error) {
                showStatus('captureStatus', `List photos error: ${error.message}`, 'error');
            }
        }
        
        async function listVideos() {
            try {
                const response = await fetch(`${CAMERA_SERVICE_URL}/list_videos`);
                const data = await response.json();
                
                if (response.ok && data.success) {
                    showStatus('captureStatus', `Found ${data.count} videos`, 'success');
                    updateResults('captureResults', `Videos (${data.count}) - displayed below:`);
                    
                    // Display videos in gallery
                    const gallery = document.getElementById('mediaGallery');
                    gallery.innerHTML = '';
                    
                    data.videos.forEach(video => {
                        const mediaItem = document.createElement('div');
                        mediaItem.className = 'media-item';
                        
                        mediaItem.innerHTML = `
                            ${createVideoElement(video.filename)}
                            <div class="media-info">
                                <div class="media-filename">üé• ${video.filename}</div>
                                <div class="media-timestamp">${new Date(video.timestamp).toLocaleString()}</div>
                                <div class="media-timestamp">${(video.size / 1024).toFixed(1)} KB</div>
                            </div>
                        `;
                        
                        gallery.appendChild(mediaItem);
                    });
                }
            } catch (error) {
                showStatus('captureStatus', `List videos error: ${error.message}`, 'error');
            }
        }
        
        async function listAllMedia() {
            try {
                // Fetch both photos and videos
                const [photosResponse, videosResponse] = await Promise.all([
                    fetch(`${CAMERA_SERVICE_URL}/list_photos`),
                    fetch(`${CAMERA_SERVICE_URL}/list_videos`)
                ]);
                
                const photosData = await photosResponse.json();
                const videosData = await videosResponse.json();
                
                if (photosResponse.ok && videosResponse.ok && photosData.success && videosData.success) {
                    const totalCount = photosData.count + videosData.count;
                    showStatus('captureStatus', `Found ${totalCount} media files (${photosData.count} photos, ${videosData.count} videos)`, 'success');
                    updateResults('captureResults', `All Media (${totalCount}) - displayed below:`);
                    
                    // Combine and sort by timestamp (newest first)
                    const allMedia = [
                        ...photosData.photos.map(p => ({...p, type: 'photo'})),
                        ...videosData.videos.map(v => ({...v, type: 'video'}))
                    ].sort((a, b) => b.timestamp - a.timestamp);
                    
                    // Display all media in gallery
                    const gallery = document.getElementById('mediaGallery');
                    gallery.innerHTML = ''; // Clear placeholder text
                    
                    if (allMedia.length === 0) {
                        gallery.innerHTML = `
                            <div style="text-align: center; color: #666; padding: 40px;">
                                <p>üé¨ No media captured yet</p>
                                <p>Start making gestures or use manual controls to see your captures here!</p>
                            </div>
                        `;
                        return;
                    }
                    
                    allMedia.forEach(media => {
                        const mediaItem = document.createElement('div');
                        mediaItem.className = 'media-item';
                        
                        if (media.type === 'photo') {
                            mediaItem.innerHTML = `
                                <img src="${CAMERA_SERVICE_URL}/photos/${media.filename}" 
                                     alt="${media.filename}"
                                     onerror="this.style.display='none'">
                                <div class="media-info">
                                    <div class="media-filename">üì∏ ${media.filename}</div>
                                    <div class="media-timestamp">${new Date(media.timestamp).toLocaleString()}</div>
                                    <div class="media-timestamp">${(media.size / 1024).toFixed(1)} KB</div>
                                </div>
                            `;
                        } else {
                            mediaItem.innerHTML = `
                                ${createVideoElement(media.filename)}
                                <div class="media-info">
                                    <div class="media-filename">üé• ${media.filename}</div>
                                    <div class="media-timestamp">${new Date(media.timestamp).toLocaleString()}</div>
                                    <div class="media-timestamp">${(media.size / 1024).toFixed(1)} KB</div>
                                </div>
                            `;
                        }
                        
                        gallery.appendChild(mediaItem);
                    });
                }
            } catch (error) {
                showStatus('captureStatus', `List media error: ${error.message}`, 'error');
            }
        }
        
        async function toggleFaceBoxes(enabled) {
            try {
                const response = await fetch(`${CAMERA_SERVICE_URL}/toggle_face_visualization`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ enabled })
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    showStatus('visualizationStatus', `Face boxes ${enabled ? 'enabled' : 'disabled'}`, 'success');
                    document.getElementById('enableFaceBoxes').classList.toggle('active', enabled);
                    document.getElementById('disableFaceBoxes').classList.toggle('active', !enabled);
                }
            } catch (error) {
                showStatus('visualizationStatus', `Face boxes error: ${error.message}`, 'error');
            }
        }
        
        async function toggleGestureVisualization(enabled) {
            try {
                const response = await fetch(`${CAMERA_SERVICE_URL}/toggle_gesture_visualization`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ enabled })
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    showStatus('visualizationStatus', `Gesture labels ${enabled ? 'enabled' : 'disabled'}`, 'success');
                    document.getElementById('enableGestureViz').classList.toggle('active', enabled);
                    document.getElementById('disableGestureViz').classList.toggle('active', !enabled);
                }
            } catch (error) {
                showStatus('visualizationStatus', `Gesture visualization error: ${error.message}`, 'error');
            }
        }
        
        async function healthCheck() {
            try {
                const response = await fetch(`${CAMERA_SERVICE_URL}/health`);
                const data = await response.json();
                
                if (response.ok) {
                    showStatus('systemStatus', `System healthy - ${data.buffer_fps.toFixed(1)} FPS`, 'success');
                    updateResults('systemResults', JSON.stringify(data, null, 2));
                } else {
                    showStatus('systemStatus', 'Health check failed', 'error');
                }
            } catch (error) {
                showStatus('systemStatus', `Health check error: ${error.message}`, 'error');
            }
        }
        
        function refreshStream() {
            const videoElement = document.getElementById('videoStream');
            videoElement.src = `${CAMERA_SERVICE_URL}/stream?t=${Date.now()}`;
            showStatus('systemStatus', 'Stream refreshed', 'success');
        }
        
        function startVideoStream() {
            const videoElement = document.getElementById('videoStream');
            videoElement.src = `${CAMERA_SERVICE_URL}/stream`;
            videoElement.style.display = 'block';
            
            videoElement.onerror = function() {
                showStatus('systemStatus', 'Video stream failed to load', 'error');
            };
            
            videoElement.onload = function() {
                showStatus('systemStatus', 'Video stream loaded successfully', 'success');
            };
        }
        
        async function testVideoUrls() {
            try {
                showStatus('systemStatus', 'Testing video URLs...', 'info');
                
                // Get list of videos
                const response = await fetch(`${CAMERA_SERVICE_URL}/list_videos`);
                const data = await response.json();
                
                if (response.ok && data.success && data.videos.length > 0) {
                    let testResults = 'Video URL Tests:\n\n';
                    
                    for (const video of data.videos) {
                        const videoUrl = `${CAMERA_SERVICE_URL}/videos/${video.filename}`;
                        
                        try {
                            const headResponse = await fetch(videoUrl, { method: 'HEAD' });
                            const status = headResponse.ok ? '‚úÖ OK' : `‚ùå ${headResponse.status}`;
                            const contentType = headResponse.headers.get('content-type') || 'unknown';
                            const contentLength = headResponse.headers.get('content-length') || 'unknown';
                            
                            testResults += `${video.filename}:\n`;
                            testResults += `  Status: ${status}\n`;
                            testResults += `  Type: ${contentType}\n`;
                            testResults += `  Size: ${contentLength} bytes\n`;
                            testResults += `  URL: ${videoUrl}\n\n`;
                        } catch (error) {
                            testResults += `${video.filename}: ‚ùå Error - ${error.message}\n\n`;
                        }
                    }
                    
                    updateResults('systemResults', testResults);
                    showStatus('systemStatus', 'Video URL test completed', 'success');
                } else {
                    showStatus('systemStatus', 'No videos found to test', 'info');
                }
            } catch (error) {
                showStatus('systemStatus', `Video test error: ${error.message}`, 'error');
            }
        }
        
        async function testVideoPlayback() {
            try {
                showStatus('systemStatus', 'Testing video playback...', 'info');
                
                // Get list of videos
                const response = await fetch(`${CAMERA_SERVICE_URL}/list_videos`);
                const data = await response.json();
                
                if (response.ok && data.success && data.videos.length > 0) {
                    const testVideo = data.videos[0]; // Use first video
                    const videoUrl = `${CAMERA_SERVICE_URL}/videos/${testVideo.filename}`;
                    
                    // Create a test video element programmatically
                    const testContainer = document.getElementById('systemResults');
                    testContainer.innerHTML = `
                        <h4>Video Playback Test:</h4>
                        <p>Testing: ${testVideo.filename}</p>
                        <video id="testVideoElement" controls style="width: 300px; height: 200px; background: #f0f0f0;">
                            <source src="${videoUrl}" type="video/mp4">
                            <p>Video not supported</p>
                        </video>
                        <br><br>
                        <div id="videoTestLog"></div>
                    `;
                    
                    const videoElement = document.getElementById('testVideoElement');
                    const logDiv = document.getElementById('videoTestLog');
                    
                    // Add comprehensive event listeners
                    videoElement.addEventListener('loadstart', () => {
                        logDiv.innerHTML += '‚úÖ Load started<br>';
                    });
                    
                    videoElement.addEventListener('loadedmetadata', () => {
                        logDiv.innerHTML += '‚úÖ Metadata loaded<br>';
                        logDiv.innerHTML += `üìä Duration: ${videoElement.duration}s<br>`;
                        logDiv.innerHTML += `üìê Size: ${videoElement.videoWidth}x${videoElement.videoHeight}<br>`;
                    });
                    
                    videoElement.addEventListener('canplay', () => {
                        logDiv.innerHTML += '‚úÖ Can play<br>';
                        videoElement.style.background = '#000';
                    });
                    
                    videoElement.addEventListener('canplaythrough', () => {
                        logDiv.innerHTML += '‚úÖ Can play through<br>';
                    });
                    
                    videoElement.addEventListener('error', (e) => {
                        logDiv.innerHTML += `‚ùå Error: ${e.message || 'Unknown error'}<br>`;
                        console.error('Video error:', e);
                    });
                    
                    // Force load
                    videoElement.load();
                    
                    showStatus('systemStatus', 'Video playback test started - check results below', 'success');
                } else {
                    showStatus('systemStatus', 'No videos found to test playback', 'info');
                }
            } catch (error) {
                showStatus('systemStatus', `Video playback test error: ${error.message}`, 'error');
            }
        }
        
        // Auto-start on page load
        window.onload = function() {
            showStatus('connectionStatus', 'Ready to connect. Enter your wallet address and click Connect.', 'info');
            updateSessionInfo();
        };
    </script>
</body>
</html> 