version: '3.8'

services:
  camera-service:
    build: .
    container_name: unified-camera-service
    restart: unless-stopped
    
    # GPU support - matches your working demo setup
    runtime: nvidia
    
    # Privileged access for camera devices
    privileged: true
    
    # Network configuration
    network_mode: host
    
    # Environment variables
    environment:
      - DISPLAY=${DISPLAY}
      - CUDA_VISIBLE_DEVICES=0
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=compute,utility
    
    # Volume mounts - matches your working demo
    volumes:
      # Camera devices
      - /dev:/dev
      
      # X11 for display (if needed)
      - /tmp/.X11-unix:/tmp/.X11-unix
      
      # Cache directories for models (matches your demo)
      - /mnt/nvme/jetson_cache/insightface:/root/.insightface
      - /mnt/nvme/jetson_cache/ultralytics:/root/.config/Ultralytics
      
      # Persistent data directories
      - ./faces:/workspace/faces
      - ./photos:/workspace/photos
      - ./videos:/workspace/videos
      - ./logs:/workspace/logs
      - ./config:/workspace/config
      
      # Bind mount the current directory as workspace
      - .:/workspace
    
    # Working directory
    working_dir: /workspace
    
    # Port mapping (main camera service, not demo)
    ports:
      - "5003:5003"
    
    # Health check
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5003/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    
    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

# Optional: Create docker-compose.dev.yml for development overrides
# Use: docker-compose -f docker-compose.yml -f docker-compose.dev.yml up 