version: '3.8'

services:
  camera-service:
    # Run in production mode to prevent ANY restarts that cause camera conflicts
    command: >
      bash -c "
      pip install flask insightface >/dev/null 2>&1 && 
      export CAMERA_DEVICE=/dev/video1 &&
      echo 'üîß FORCED CAMERA DEVICE: /dev/video1 (Logitech StreamCam)' &&
      echo 'üìπ Available video devices:' && ls -la /dev/video* &&
      echo 'üîç Testing camera access...' &&
      python3 -c 'import cv2; cap = cv2.VideoCapture(\"/dev/video1\"); print(f\"Camera open: {cap.isOpened()}\"); cap.release()' &&
      echo 'üöÄ Starting camera service in PRODUCTION mode (no restarts)...' &&
      python3 main.py --host 0.0.0.0 --port 5003
      "
    
    # Production environment - no debug/development settings
    environment:
      - DISPLAY=${DISPLAY}
      - CUDA_VISIBLE_DEVICES=0
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=compute,utility
      - PYTHONUNBUFFERED=1
      - PYTHONDONTWRITEBYTECODE=1
      - CAMERA_DEVICE=/dev/video1  # Force Logitech camera
    
    # Ensure proper device access
    privileged: true
    
    # Add all video devices with proper permissions
    devices:
      - /dev/video0:/dev/video0
      - /dev/video1:/dev/video1
      - /dev/video2:/dev/video2
    
    # Add extra volumes for development
    volumes:
      # Camera devices
      - /dev:/dev
      
      # X11 for display (if needed)
      - /tmp/.X11-unix:/tmp/.X11-unix
      
      # Cache directories for models
      - /mnt/nvme/jetson_cache/insightface:/root/.insightface
      - /mnt/nvme/jetson_cache/ultralytics:/root/.config/Ultralytics
      
      # Persistent data directories
      - ./faces:/workspace/faces
      - ./photos:/workspace/photos
      - ./videos:/workspace/videos
      - ./logs:/workspace/logs
      - ./config:/workspace/config
      
      # Bind mount the current directory as workspace for live editing
      - .:/workspace
      
      # Also mount templates and static directories explicitly for immediate updates
      - ./templates:/workspace/templates
      - ./static:/workspace/static 